#include <math.h>
#include "parameters.h"

#include <iostream>
static inline float dist_diff(float dx, float dy, float dz) {

    return sqrtf(dx*dx+dy*dy+dz*dz);

}


static inline float f_C(float r_ij, float r_c) {
    if (r_ij <= r_c) {
        return 0.5 * cosf((M_PI * r_ij) / r_c) + 0.5;
    } else {
        return 0;
    }
}


static inline int linearize(int i, int j, int k, int l) {
    if(j < i) {
        float tmp = i;
        i = j;
        j = tmp;
    }

    const int N = MAX_ATOM_TYPES;
    const int K = NUM_A_THETAS;
    const int L = NUM_A_RS;

    int basis = (N*(N-1)/2 - (N-i) * (N-i-1)/2 +j);
    
    return basis*K*L + k*L + l;
}



void featurize_grad_inverse(
    const float *input_Xs,
    const float *input_Ys,
    const float *input_Zs,
    const int *input_As,
    const int *mol_offsets,
    const int *input_MACs,
    const int n_mols, // denotes where the atom is being displaced to
    const int *scatter_idxs, // used to retrieve the grad multiplication factor for backprop
    const float *X_grads,
    const float *Y_grads,
    const float *Z_grads, 

    float *H_grads,
    float *C_grads,
    float *N_grads,
    float *O_grads) {
  
    // this is a loop over all unique pairs and triples
    for(int mol_idx=0; mol_idx < n_mols; mol_idx++) {

        int num_atoms = input_MACs[mol_idx];

        for(int i_idx = 0; i_idx < num_atoms; i_idx++) {

            int g_atom_idx_i = mol_offsets[mol_idx] + i_idx;
            int g_atomic_num_i = input_As[g_atom_idx_i];

            float i_x = input_Xs[g_atom_idx_i];
            float i_y = input_Ys[g_atom_idx_i];
            float i_z = input_Zs[g_atom_idx_i];

            float *X_grads_i, *Y_grads_i, *Z_grads_i;

            float *input_buffer_i;
            if(g_atomic_num_i == 0) {
                input_buffer_i = H_grads;
            } else if(g_atomic_num_i == 1) {
                input_buffer_i = C_grads;
            } else if(g_atomic_num_i == 2) {
                input_buffer_i = N_grads;
            } else {
                input_buffer_i = O_grads;
            }

            float *radial_feature_buffer_i = input_buffer_i + scatter_idxs[g_atom_idx_i]*TOTAL_FEATURE_SIZE + 0;
            float *angular_feature_buffer_i = input_buffer_i + scatter_idxs[g_atom_idx_i]*TOTAL_FEATURE_SIZE + RADIAL_FEATURE_SIZE;

            for(int j_idx = 0; j_idx < num_atoms; j_idx++) {
                int g_atom_idx_j = mol_offsets[mol_idx]+j_idx;
                int g_atomic_num_j = input_As[g_atom_idx_j];

                float j_x = input_Xs[g_atom_idx_j];
                float j_y = input_Ys[g_atom_idx_j];
                float j_z = input_Zs[g_atom_idx_j];

                float d_ij_x = i_x - j_x;
                float d_ij_y = i_y - j_y;
                float d_ij_z = i_z - j_z;

                float r_ij = dist_diff(d_ij_x, d_ij_y, d_ij_z);

                // note: the potential is computed as i_idx < j_idx but it double counts.
                if(r_ij < R_Rc && i_idx != j_idx) {
                    for(int r_idx = 0; r_idx < NUM_R_Rs; r_idx++) {
                        float accum_i_x = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(i_x - j_x)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(i_x - j_x)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_i_y = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(i_y - j_y)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(i_y - j_y)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_i_z = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(i_z - j_z)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(i_z - j_z)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);

                        double accumulant = accum_i_x * X_grads[g_atomic_num_i] + accum_i_y * Y_grads[g_atomic_num_i] + accum_i_z * Z_grads[g_atomic_num_i];
                        radial_feature_buffer_i[input_As[g_atom_idx_j] * NUM_R_Rs + r_idx] += accumulant;

                        float accum_j_x = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(-i_x + j_x)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(-i_x + j_x)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_j_y = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(-i_y + j_y)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(-i_y + j_y)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_j_z = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(-i_z + j_z)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(-i_z + j_z)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);

                        accumulant = accum_j_x * X_grads[g_atomic_num_i] + accum_j_y * Y_grads[g_atomic_num_i] + accum_j_z * Z_grads[g_atomic_num_i];
                        radial_feature_buffer_i[input_As[g_atom_idx_j] * NUM_R_Rs + r_idx] += accumulant;
                    }
                }

                float A_f_C_ij = f_C(r_ij, A_Rc);

                if(r_ij < A_Rc) {
                    for(int k_idx = j_idx+1; k_idx < num_atoms; k_idx++) {
                        if(i_idx == j_idx || i_idx == k_idx || j_idx == k_idx) {
                            continue;
                        }
                        int g_atom_idx_k = mol_offsets[mol_idx]+k_idx;
                        int g_atomic_num_k = input_As[g_atom_idx_k];

                        const int an_j = input_As[g_atom_idx_j];
                        const int an_k = input_As[g_atom_idx_k];

                        float k_x = input_Xs[g_atom_idx_k];
                        float k_y = input_Ys[g_atom_idx_k];
                        float k_z = input_Zs[g_atom_idx_k];

                        float d_ik_x = i_x - k_x;
                        float d_ik_y = i_y - k_y;
                        float d_ik_z = i_z - k_z;

                        float r_ik = dist_diff(d_ik_x, d_ik_y, d_ik_z);

                        if(r_ik < A_Rc) {
                            float A_f_C_ik = f_C(r_ik, A_Rc);
                            for(int t=0; t < NUM_A_THETAS; t++) {
                                for(int s=0; s < NUM_A_RS; s++) {
                                    float accum_i_x = -pow(2, -A_zeta + 1)*A_eta*((i_x - j_x)/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (i_x - k_x)/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_x + j_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_x + j_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_x + k_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (-i_x + k_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*j_y - 2*k_y)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(-2*j_z + 2*k_z)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))) + (2*i_x - j_x - k_x)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_x - j_x)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_x - k_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_i_y = -pow(2, -A_zeta + 1)*A_eta*((i_y - j_y)/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (i_y - k_y)/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_y + j_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_y + j_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_y + k_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (-i_y + k_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(-2*j_x + 2*k_x)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(2*j_z - 2*k_z)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))) + (2*i_y - j_y - k_y)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_y - j_y)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_y - k_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_i_z = -pow(2, -A_zeta + 1)*A_eta*((i_z - j_z)/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (i_z - k_z)/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_z + j_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_z + j_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_z + k_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (-i_z + k_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*j_x - 2*k_x)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)) + (1.0L/2.0L)*(-2*j_y + 2*k_y)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))) + (2*i_z - j_z - k_z)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_z - j_z)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_z - k_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));

                                    double accumulant = accum_i_x * X_grads[g_atomic_num_i] + accum_i_y * Y_grads[g_atomic_num_i] + accum_i_z * Z_grads[g_atomic_num_i];
                                    angular_feature_buffer_i[linearize(an_j, an_k, t, s)] += accumulant;

                                    float accum_j_x = -pow(2, -A_zeta + 1)*A_eta*(-i_x + j_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_x + k_x)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_x - j_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_x - j_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + ((1.0L/2.0L)*(-2*i_y + 2*k_y)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(2*i_z - 2*k_z)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_x + j_x)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)));
                                    float accum_j_y = -pow(2, -A_zeta + 1)*A_eta*(-i_y + j_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_y + k_y)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_y - j_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_y - j_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + ((1.0L/2.0L)*(2*i_x - 2*k_x)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(-2*i_z + 2*k_z)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_y + j_y)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)));
                                    float accum_j_z = -pow(2, -A_zeta + 1)*A_eta*(-i_z + j_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_z + k_z)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_z - j_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_z - j_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + ((1.0L/2.0L)*(-2*i_x + 2*k_x)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)) + (1.0L/2.0L)*(2*i_y - 2*k_y)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_z + j_z)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)));

                                    accumulant = accum_j_x * X_grads[g_atomic_num_i] + accum_j_y * Y_grads[g_atomic_num_i] + accum_j_z * Z_grads[g_atomic_num_i];
                                    angular_feature_buffer_i[linearize(an_j, an_k, t, s)] += accumulant;

                                    float accum_k_x = -pow(2, -A_zeta + 1)*A_eta*(-i_x + k_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_x + j_x)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_x - k_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (i_x - k_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*i_y - 2*j_y)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(-2*i_z + 2*j_z)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_x + k_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_k_y = -pow(2, -A_zeta + 1)*A_eta*(-i_y + k_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_y + j_y)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_y - k_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (i_y - k_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(-2*i_x + 2*j_x)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(2*i_z - 2*j_z)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_y + k_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_k_z = -pow(2, -A_zeta + 1)*A_eta*(-i_z + k_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_z + j_z)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_z - k_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (i_z - k_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*i_x - 2*j_x)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)) + (1.0L/2.0L)*(-2*i_y + 2*j_y)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_z + k_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));

                                    accumulant = accum_k_x * X_grads[g_atomic_num_i] + accum_k_y * Y_grads[g_atomic_num_i] + accum_k_z * Z_grads[g_atomic_num_i];
                                    angular_feature_buffer_i[linearize(an_j, an_k, t, s)] += accumulant;
                                }
                            }     
                        }
                    }
                }
            }
        }
    }
}

void featurize_grad_cpu(
    const float *input_Xs,
    const float *input_Ys,
    const float *input_Zs,
    const int *input_As,
    const int *mol_offsets,
    const int *input_MACs,
    const int n_mols, // denotes where the atom is being displaced to
    const int *scatter_idxs, // used to retrieve the grad multiplication factor for backprop
    const float *H_grads,
    const float *C_grads,
    const float *N_grads,
    const float *O_grads,
    float *X_grads,
    float *Y_grads,
    float *Z_grads
    ) {
  
    // this is a loop over all unique pairs and triples
    for(int mol_idx=0; mol_idx < n_mols; mol_idx++) {

        int num_atoms = input_MACs[mol_idx];

        for(int i_idx = 0; i_idx < num_atoms; i_idx++) {

            int g_atom_idx_i = mol_offsets[mol_idx] + i_idx;
            int g_atomic_num_i = input_As[g_atom_idx_i];

            float i_x = input_Xs[g_atom_idx_i];
            float i_y = input_Ys[g_atom_idx_i];
            float i_z = input_Zs[g_atom_idx_i];

            float *X_grads_i, *Y_grads_i, *Z_grads_i;

            const float *output_buffer_i;
            if(g_atomic_num_i == 0) {
                output_buffer_i = H_grads;
            } else if(g_atomic_num_i == 1) {
                output_buffer_i = C_grads;
            } else if(g_atomic_num_i == 2) {
                output_buffer_i = N_grads;
            } else {
                output_buffer_i = O_grads;
            }

            const float *radial_feature_buffer_i = output_buffer_i + scatter_idxs[g_atom_idx_i]*TOTAL_FEATURE_SIZE + 0;
            const float *angular_feature_buffer_i = output_buffer_i + scatter_idxs[g_atom_idx_i]*TOTAL_FEATURE_SIZE + RADIAL_FEATURE_SIZE;

            for(int j_idx = 0; j_idx < num_atoms; j_idx++) {
                int g_atom_idx_j = mol_offsets[mol_idx]+j_idx;
                int g_atomic_num_j = input_As[g_atom_idx_j];

                float j_x = input_Xs[g_atom_idx_j];
                float j_y = input_Ys[g_atom_idx_j];
                float j_z = input_Zs[g_atom_idx_j];

                float d_ij_x = i_x - j_x;
                float d_ij_y = i_y - j_y;
                float d_ij_z = i_z - j_z;

                float r_ij = dist_diff(d_ij_x, d_ij_y, d_ij_z);

                // note: the potential is computed as i_idx < j_idx but it double counts.
                if(r_ij < R_Rc && i_idx != j_idx) {
                    for(int r_idx = 0; r_idx < NUM_R_Rs; r_idx++) {
                        float d_y_i = radial_feature_buffer_i[input_As[g_atom_idx_j] * NUM_R_Rs + r_idx]; // gradient broadcast

                        float accum_i_x = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(i_x - j_x)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(i_x - j_x)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_i_y = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(i_y - j_y)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(i_y - j_y)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                    float accum_i_z = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(i_z - j_z)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(i_z - j_z)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);

                        X_grads[g_atom_idx_i] += accum_i_x * d_y_i;
                        Y_grads[g_atom_idx_i] += accum_i_y * d_y_i;
                        Z_grads[g_atom_idx_i] += accum_i_z * d_y_i;

                        float accum_j_x = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(-i_x + j_x)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(-i_x + j_x)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_j_y = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(-i_y + j_y)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(-i_y + j_y)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);
                        float accum_j_z = -2*R_eta*(-R_Rs[r_idx] + r_ij)*(-i_z + j_z)*(0.5*cos(M_PI*r_ij/R_Rc) + 0.5)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))/r_ij - 0.5*M_PI*(-i_z + j_z)*exp(-R_eta*pow(-R_Rs[r_idx] + r_ij, 2))*sin(M_PI*r_ij/R_Rc)/(R_Rc*r_ij);

                        X_grads[g_atom_idx_j] += accum_j_x * d_y_i;
                        Y_grads[g_atom_idx_j] += accum_j_y * d_y_i;
                        Z_grads[g_atom_idx_j] += accum_j_z * d_y_i;

                    }
                }

                float A_f_C_ij = f_C(r_ij, A_Rc);

                if(r_ij < A_Rc) {
                    for(int k_idx = j_idx+1; k_idx < num_atoms; k_idx++) {
                        if(i_idx == j_idx || i_idx == k_idx || j_idx == k_idx) {
                            continue;
                        }
                        int g_atom_idx_k = mol_offsets[mol_idx]+k_idx;
                        int g_atomic_num_k = input_As[g_atom_idx_k];

                        const int an_j = input_As[g_atom_idx_j];
                        const int an_k = input_As[g_atom_idx_k];

                        float k_x = input_Xs[g_atom_idx_k];
                        float k_y = input_Ys[g_atom_idx_k];
                        float k_z = input_Zs[g_atom_idx_k];

                        float d_ik_x = i_x - k_x;
                        float d_ik_y = i_y - k_y;
                        float d_ik_z = i_z - k_z;

                        float r_ik = dist_diff(d_ik_x, d_ik_y, d_ik_z);

                        if(r_ik < A_Rc) {
                            float A_f_C_ik = f_C(r_ik, A_Rc);
                            for(int t=0; t < NUM_A_THETAS; t++) {
                                for(int s=0; s < NUM_A_RS; s++) {

                                    float d_y_i = angular_feature_buffer_i[linearize(an_j, an_k, t, s)];

                                    float accum_i_x = -pow(2, -A_zeta + 1)*A_eta*((i_x - j_x)/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (i_x - k_x)/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_x + j_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_x + j_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_x + k_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (-i_x + k_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*j_y - 2*k_y)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(-2*j_z + 2*k_z)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))) + (2*i_x - j_x - k_x)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_x - j_x)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_x - k_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_i_y = -pow(2, -A_zeta + 1)*A_eta*((i_y - j_y)/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (i_y - k_y)/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_y + j_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_y + j_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_y + k_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (-i_y + k_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(-2*j_x + 2*k_x)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(2*j_z - 2*k_z)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))) + (2*i_y - j_y - k_y)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_y - j_y)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_y - k_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_i_z = -pow(2, -A_zeta + 1)*A_eta*((i_z - j_z)/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (i_z - k_z)/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_z + j_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_z + j_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (-i_z + k_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (-i_z + k_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*j_x - 2*k_x)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)) + (1.0L/2.0L)*(-2*j_y + 2*k_y)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))) + (2*i_z - j_z - k_z)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_z - j_z)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(i_z - k_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));

                                    X_grads[g_atom_idx_i] += accum_i_x * d_y_i;
                                    Y_grads[g_atom_idx_i] += accum_i_y * d_y_i;
                                    Z_grads[g_atom_idx_i] += accum_i_z * d_y_i;

                                    float accum_j_x = -pow(2, -A_zeta + 1)*A_eta*(-i_x + j_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_x + k_x)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_x - j_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_x - j_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + ((1.0L/2.0L)*(-2*i_y + 2*k_y)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(2*i_z - 2*k_z)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_x + j_x)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)));
                                    float accum_j_y = -pow(2, -A_zeta + 1)*A_eta*(-i_y + j_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_y + k_y)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_y - j_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_y - j_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + ((1.0L/2.0L)*(2*i_x - 2*k_x)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(-2*i_z + 2*k_z)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_y + j_y)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)));
                                    float accum_j_z = -pow(2, -A_zeta + 1)*A_eta*(-i_z + j_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_z + k_z)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_z - j_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_z - j_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(pow(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2), 3.0L/2.0L)*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + ((1.0L/2.0L)*(-2*i_x + 2*k_x)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)) + (1.0L/2.0L)*(2*i_y - 2*k_y)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_z + j_z)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)));

                                    X_grads[g_atom_idx_j] += accum_j_x * d_y_i;
                                    Y_grads[g_atom_idx_j] += accum_j_y * d_y_i;
                                    Z_grads[g_atom_idx_j] += accum_j_z * d_y_i;

                                    float accum_k_x = -pow(2, -A_zeta + 1)*A_eta*(-i_x + k_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_x + j_x)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_x - k_x)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (i_x - k_x)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*i_y - 2*j_y)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(-2*i_z + 2*j_z)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_x + k_x)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_k_y = -pow(2, -A_zeta + 1)*A_eta*(-i_y + k_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_y + j_y)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_y - k_y)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (i_y - k_y)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(-2*i_x + 2*j_x)*((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y)) + (1.0L/2.0L)*(2*i_z - 2*j_z)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_y + k_y)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));
                                    float accum_k_z = -pow(2, -A_zeta + 1)*A_eta*(-i_z + k_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)))*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)) + pow(2, -A_zeta + 1)*A_zeta*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*(0.5*cos(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*((-i_z + j_z)*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + (i_z - k_z)*((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + (i_z - k_z)*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*pow(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2), 3.0L/2.0L)) + ((1.0L/2.0L)*(2*i_x - 2*j_x)*(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z)) + (1.0L/2.0L)*(-2*i_y + 2*j_y)*((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z)))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))*sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))))*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))/(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2)))) - 0.5*pow(2, -A_zeta + 1)*M_PI*(-i_z + k_z)*(0.5*cos(M_PI*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2))/A_Rc) + 0.5)*pow(((-i_x + j_x)*(-i_x + k_x) + (-i_y + j_y)*(-i_y + k_y) + (-i_z + j_z)*(-i_z + k_z))*cos(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))) + 1 + sqrt(pow((-i_x + j_x)*(-i_y + k_y) - (-i_x + k_x)*(-i_y + j_y), 2) + pow(-(-i_x + j_x)*(-i_z + k_z) + (-i_x + k_x)*(-i_z + j_z), 2) + pow((-i_y + j_y)*(-i_z + k_z) - (-i_y + k_y)*(-i_z + j_z), 2))*sin(A_thetas[t])/(sqrt(pow(-i_x + j_x, 2) + pow(-i_y + j_y, 2) + pow(-i_z + j_z, 2))*sqrt(pow(-i_x + k_x, 2) + pow(-i_y + k_y, 2) + pow(-i_z + k_z, 2))), A_zeta)*exp(-A_eta*pow(-A_Rs[s] + (1.0L/2.0L)*sqrt(pow(i_x - j_x, 2) + pow(i_y - j_y, 2) + pow(i_z - j_z, 2)) + (1.0L/2.0L)*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)), 2))*sin(M_PI*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2))/A_Rc)/(A_Rc*sqrt(pow(i_x - k_x, 2) + pow(i_y - k_y, 2) + pow(i_z - k_z, 2)));

                                    X_grads[g_atom_idx_k] += accum_k_x * d_y_i;
                                    Y_grads[g_atom_idx_k] += accum_k_y * d_y_i;
                                    Z_grads[g_atom_idx_k] += accum_k_z * d_y_i;
                                }
                            }     
                        }
                    }
                }
            }
        }
    }
}

void featurize_cpu(
    const float *input_Xs,
    const float *input_Ys,
    const float *input_Zs,
    const int *input_As,
    const int *mol_offsets,
    const int *input_MACs,
    const int n_mols,
    const int *scatter_idxs, // denotes where the atom is being displaced to
    float *X_feat_out_H,
    float *X_feat_out_C,
    float *X_feat_out_N,
    float *X_feat_out_O) {
 
    // std::cout << "start featurize_cpu" << std::endl;


    // this is a loop over all unique pairs and triples
    for(int mol_idx=0; mol_idx < n_mols; mol_idx++) {

        int num_atoms = input_MACs[mol_idx];

        for(int i_idx = 0; i_idx < num_atoms; i_idx++) {

            int g_atom_idx_i = mol_offsets[mol_idx] + i_idx;
            int g_atomic_num_i = input_As[g_atom_idx_i];

            float i_x = input_Xs[g_atom_idx_i];
            float i_y = input_Ys[g_atom_idx_i];
            float i_z = input_Zs[g_atom_idx_i];

            float *X_feat_out_i;
            if(g_atomic_num_i == 0) {
                X_feat_out_i = X_feat_out_H;
            } else if(g_atomic_num_i == 1) {
                X_feat_out_i = X_feat_out_C;
            } else if(g_atomic_num_i == 2) {
                X_feat_out_i = X_feat_out_N;
            } else {
                X_feat_out_i = X_feat_out_O;
            }

            float *radial_feature_buffer_i = X_feat_out_i + scatter_idxs[g_atom_idx_i]*TOTAL_FEATURE_SIZE + 0;
            float *angular_feature_buffer_i = X_feat_out_i + scatter_idxs[g_atom_idx_i]*TOTAL_FEATURE_SIZE + RADIAL_FEATURE_SIZE;

            for(int j_idx = 0; j_idx < num_atoms; j_idx++) {
                int g_atom_idx_j = mol_offsets[mol_idx]+j_idx;
                int g_atomic_num_j = input_As[g_atom_idx_j];

                float j_x = input_Xs[g_atom_idx_j];
                float j_y = input_Ys[g_atom_idx_j];
                float j_z = input_Zs[g_atom_idx_j];

                float d_ij_x = i_x - j_x;
                float d_ij_y = i_y - j_y;
                float d_ij_z = i_z - j_z;

                float r_ij = dist_diff(d_ij_x, d_ij_y, d_ij_z);

                float *X_feat_out_j;
                if(g_atomic_num_j == 0) {
                    X_feat_out_j = X_feat_out_H;
                } else if(g_atomic_num_j == 1) {
                    X_feat_out_j = X_feat_out_C;
                } else if(g_atomic_num_j == 2) {
                    X_feat_out_j = X_feat_out_N;
                } else {
                    X_feat_out_j = X_feat_out_O;
                }

                float *radial_feature_buffer_j = X_feat_out_j + scatter_idxs[g_atom_idx_j]*TOTAL_FEATURE_SIZE + 0;

                if(r_ij < R_Rc && i_idx < j_idx) {
                    for(int r_idx = 0; r_idx < NUM_R_Rs; r_idx++) {
                        float summand = expf(-R_eta * powf(r_ij - R_Rs[r_idx], 2.0)) * f_C(r_ij, R_Rc);
                        radial_feature_buffer_i[input_As[g_atom_idx_j] * NUM_R_Rs + r_idx] += summand;
                        radial_feature_buffer_j[input_As[g_atom_idx_i] * NUM_R_Rs + r_idx] += summand;
                    }
                }

                float A_f_C_ij = f_C(r_ij, A_Rc);

                if(r_ij < A_Rc) {
                    for(int k_idx = j_idx+1; k_idx < num_atoms; k_idx++) {
                        if(i_idx == j_idx || i_idx == k_idx || j_idx == k_idx) {
                            continue;
                        }
                        int g_atom_idx_k = mol_offsets[mol_idx]+k_idx;

                        const int an_j = input_As[g_atom_idx_j];
                        const int an_k = input_As[g_atom_idx_k];

                        float k_x = input_Xs[g_atom_idx_k];
                        float k_y = input_Ys[g_atom_idx_k];
                        float k_z = input_Zs[g_atom_idx_k];

                        float d_ik_x = i_x - k_x;
                        float d_ik_y = i_y - k_y;
                        float d_ik_z = i_z - k_z;

                        float r_ik = dist_diff(d_ik_x, d_ik_y, d_ik_z);

                        if(r_ik < A_Rc) {

                            // TODO(YTZ): replace with arctan2 trick
                            float inner = (d_ij_x*d_ik_x + d_ij_y*d_ik_y + d_ij_z*d_ik_z) / (r_ij * r_ik);
                            inner = fmaxf(inner, -1.0);
                            inner = fminf(inner,  1.0);
                            float theta_ijk = acosf(inner);
                            // super useful debug
                            // if(isnan(theta_ijk) || isinf(theta_ijk)) {
                                // printf("WTF NAN/INF: %d, %d, %d, r_ij, r_ik, %f, %f, top %f, bottom %f, i_coords:(%f, %f, %f), j_coords(%f, %f, %f), k_coords(%f, %f, %f)\n",
                                    // g_atom_idx_i, g_atom_idx_j, g_atom_idx_k, r_ij, r_ik, d_ij_x*d_ik_x + d_ij_y*d_ik_y + d_ij_z*d_ik_z, r_ij * r_ik, i_x, i_y, i_z, j_x, j_y, j_z, k_x, k_y, k_z);
                            // }

                            float A_f_C_ik = f_C(r_ik, A_Rc);
                            for(int t=0; t < NUM_A_THETAS; t++) {
                                for(int s=0; s < NUM_A_RS; s++) {
                                    float summand = powf(2, 1-A_zeta) * powf(1+cosf(theta_ijk - A_thetas[t]), A_zeta) * expf(-A_eta*powf((r_ij + r_ik)/2 - A_Rs[s], 2)) * A_f_C_ij * A_f_C_ik;
                                    angular_feature_buffer_i[linearize(an_j, an_k, t, s)] += summand;
                                }
                            }     
                        }
                    }
                }
            }
        }
    }
}